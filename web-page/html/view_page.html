<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Person</title>
    <link rel="stylesheet" href="../css/view.css">
</head>
<body>
    <div class="container">
        <div class="wrapper">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>Search Person</h1>
                <a href="/html/create_page.html" class="btn btn-primary" style="text-decoration: none; display: inline-block; padding: 10px 20px;">Create User</a>
            </div>
            
            <div class="search-section">
                <input type="text" id="personSearch" class="search-input" placeholder="Enter person name...">
                <button class="search-btn" onclick="searchPerson()">Search</button>
            </div>

            <div id="searchResults" style="display: none;">
                <div id="multipleResults" style="display: none;">
                    <h3>Found Multiple Users</h3>
                    <p>Select a user to view details:</p>
                    <div id="multipleUsersList" style="margin: 20px 0; display: grid; gap: 10px;"></div>
                </div>

                <div id="singleResult" style="display: none;">
                    <div class="person-info">
                        <h2 id="personName"></h2>
                        <p id="personEmail"></p>
                        <p id="personPhone"></p>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 20px;">Interested Sports</h3>
                    <div id="sportsContainer" class="sports-list">
                        <!-- Sports will be populated here -->
                    </div>

                    <div class="action-buttons">
                        <button class="btn-back" onclick="clearSearch()">New Search</button>
                        <button class="btn-edit-all" onclick="editUser()">Edit Sports</button>
                        <button class="btn-delete" onclick="deleteUser()">Delete User</button>
                    </div>
                </div>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                <p>No person found with that name.</p>
                <button class="btn-back" onclick="clearSearch()">Back</button>
            </div>

            <div id="initialMessage" class="initial-message">
                <p>Enter a person's name and click Search to view their interested sports.</p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration - Update this for your deployment
        const API_BASE_URL = 'http://localhost:5000/api';

        let currentPerson = null;

        async function searchPerson() {
            const searchInput = document.getElementById('personSearch').value.trim();
            
            if (!searchInput) {
                alert('Please enter a person name');
                return;
            }

            try {
                // Show loading state
                document.getElementById('initialMessage').style.display = 'none';
                document.getElementById('noResults').style.display = 'none';
                document.getElementById('searchResults').style.display = 'none';

                const response = await fetch(`${API_BASE_URL}/users/search?q=${encodeURIComponent(searchInput)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const results = await response.json();
                
                if (results.length > 0) {
                    if (results.length === 1) {
                        // Single result: display directly
                        const found = results[0];
                        currentPerson = {
                            id: found.user_id,
                            name: found.username,
                            email: found.email,
                            phone: found.phone_number,
                            sports: found.sports || []
                        };
                        displayPersonSports(currentPerson);
                    } else {
                        // Multiple results: show list to select from
                        displayMultipleResults(results);
                    }
                } else {
                    document.getElementById('initialMessage').style.display = 'none';
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('noResults').style.display = 'block';
                }
            } catch (error) {
                console.error('Error searching user:', error);
                alert(`Error: ${error.message}`);
                document.getElementById('initialMessage').style.display = 'block';
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('noResults').style.display = 'none';
            }
        }

        function displayMultipleResults(results) {
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('multipleResults').style.display = 'block';
            document.getElementById('singleResult').style.display = 'none';

            const listContainer = document.getElementById('multipleUsersList');
            listContainer.innerHTML = '';

            results.forEach(user => {
                const userCard = document.createElement('div');
                userCard.style.padding = '15px';
                userCard.style.border = '2px solid #e0e0e0';
                userCard.style.borderRadius = '8px';
                userCard.style.cursor = 'pointer';
                userCard.style.transition = 'all 0.3s ease';
                userCard.style.backgroundColor = '#f9f9f9';

                const userData = {
                    id: user.user_id,
                    name: user.username,
                    email: user.email,
                    phone: user.phone_number,
                    sports: user.sports || []
                };

                userCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;"><div>
                        <h3 style="margin: 0 0 5px 0; color: #333;">${user.username}</h3>
                        <p style="margin: 0 0 3px 0; font-size: 14px; color: #666;">${user.email}</p>
                        <p style="margin: 0; font-size: 14px; color: #666;">${user.phone_number}</p>
                    </div>
                    <button class="btn-select" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">View</button>
                    </div>
                `;

                userCard.onmouseover = () => {
                    userCard.style.backgroundColor = '#fff';
                    userCard.style.borderColor = '#667eea';
                    userCard.style.transform = 'translateY(-2px)';
                };

                userCard.onmouseout = () => {
                    userCard.style.backgroundColor = '#f9f9f9';
                    userCard.style.borderColor = '#e0e0e0';
                    userCard.style.transform = 'translateY(0)';
                };

                userCard.onclick = () => {
                    currentPerson = userData;
                    displayPersonSports(currentPerson);
                };

                listContainer.appendChild(userCard);
            });
        }

        function displayPersonSports(person) {
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('multipleResults').style.display = 'none';
            document.getElementById('singleResult').style.display = 'block';

            document.getElementById('personName').textContent = person.name;
            document.getElementById('personEmail').textContent = `Email: ${person.email}`;
            document.getElementById('personPhone').textContent = `Phone: ${person.phone}`;

            const sportsContainer = document.getElementById('sportsContainer');
            sportsContainer.innerHTML = '';

            if (person.sports.length === 0) {
                sportsContainer.innerHTML = '<p style="color: #666;">No sports added yet.</p>';
            } else {
                person.sports.forEach(sport => {
                    const sportCard = document.createElement('div');
                    sportCard.className = 'sport-card';
                    sportCard.dataset.sport = sport;
                    sportCard.innerHTML = `
                        <div class="sport-info">
                            <h3>${sport}</h3>
                        </div>
                    `;
                    sportsContainer.appendChild(sportCard);
                });
            }
        }

        function editUser() {
            window.location.href = `/html/edit_page.html?userId=${currentPerson.id}`;
        }

        function deleteUser() {
            if (confirm(`Are you sure you want to delete ${currentPerson.name} and all their sports? This action cannot be undone.`)) {
                deleteUserFromDB();
            }
        }

        async function deleteUserFromDB() {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${currentPerson.id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('User deleted successfully!');
                    clearSearch();
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function clearSearch() {
            document.getElementById('personSearch').value = '';
            document.getElementById('initialMessage').style.display = 'block';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            currentPerson = null;
        }

        // Allow Enter key to search
        document.getElementById('personSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPerson();
            }
        });
    </script>
</body>
</html>